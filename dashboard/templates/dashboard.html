<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WhiteScholars Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --panel-bg: #ffffff;
        --panel-border: #e5e7eb;
        --panel-muted: #6b7280;
        --panel-accent: #0f4c81;
        --panel-accent-dark: #0b3b64;
        --panel-soft: #f3f6fb;
        --panel-soft-border: #d7e2f1;
        --panel-danger: #b42318;
      }

      body {
        background-color: #f5f7fb;
        font-family: "Manrope", sans-serif;
        color: #111827;
      }

      .navbar {
        background: linear-gradient(90deg, #0f4c81, #0b3b64);
        box-shadow: 0 10px 24px rgba(15, 76, 129, 0.2);
      }

      .navbar-brand {
        font-weight: 700;
        letter-spacing: 0.4px;
      }

      .panel {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 12px;
      }

      .panel-title {
        font-size: 15px;
        font-weight: 700;
        margin: 0;
      }

      .panel-subtitle {
        font-size: 12px;
        color: var(--panel-muted);
        margin: 2px 0 0;
      }

      .course-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 70vh;
        overflow: auto;
        padding-right: 4px;
      }

      .course-item {
        border-radius: 12px;
        border: 1px solid transparent;
        padding: 12px;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        gap: 4px;
        transition: 0.2s ease;
      }

      .course-item:hover {
        background: var(--panel-soft);
        border-color: var(--panel-soft-border);
      }

      .course-item.active {
        background: rgba(15, 76, 129, 0.08);
        border-color: rgba(15, 76, 129, 0.4);
      }

      .course-name {
        font-weight: 600;
      }

      .course-slug {
        font-size: 12px;
        color: var(--panel-muted);
      }

      .editor-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 20px;
      }

      .editor-header h2 {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 6px;
      }

      .editor-header .meta {
        color: var(--panel-muted);
        font-size: 13px;
      }

      .editor-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 320px;
        gap: 24px;
        align-items: start;
      }

      .section-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .section-card {
        border: 1px solid var(--panel-border);
        border-radius: 14px;
        overflow: hidden;
        background: #fff;
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        cursor: pointer;
        background: #f9fafb;
      }

      .section-header:hover {
        background: #f3f4f6;
      }

      .section-info {
        flex: 1;
      }

      .section-title {
        font-weight: 700;
      }

      .section-desc {
        font-size: 12px;
        color: var(--panel-muted);
      }

      .drag-handle {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: 1px dashed var(--panel-border);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--panel-muted);
        flex: 0 0 28px;
      }

      .section-actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-body {
        padding: 18px 16px 20px;
      }

      .section-body h6 {
        font-weight: 700;
      }

      .editor-note {
        font-size: 12px;
        color: var(--panel-muted);
      }

      .required-label::after {
        content: " *";
        color: var(--panel-danger);
        font-weight: 700;
      }

      .required-hint {
        border: 1px solid var(--panel-soft-border);
        background: #f8fbff;
        color: #1f2937;
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 12px;
        margin-bottom: 12px;
      }

      .preview-card {
        border: 1px dashed var(--panel-soft-border);
        background: #f8fafc;
        border-radius: 16px;
        padding: 16px;
        position: sticky;
        top: 16px;
        max-height: calc(100vh - 140px);
        overflow: auto;
      }

      .preview-card h6 {
        font-weight: 700;
      }

      .preview-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .preview-item {
        padding: 10px 12px;
        border-radius: 10px;
        background: #fff;
        border: 1px solid var(--panel-border);
        font-size: 13px;
      }

      .preview-item.disabled {
        opacity: 0.5;
        text-decoration: line-through;
      }

      .preview-tabs .nav-link {
        font-size: 12px;
        padding: 6px 10px;
      }

      .preview-content {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .preview-section {
        border: 1px solid var(--panel-border);
        background: #fff;
        border-radius: 12px;
        padding: 12px;
      }

      .preview-section.is-disabled {
        opacity: 0.5;
      }

      .preview-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .preview-section-title {
        font-weight: 700;
        font-size: 13px;
      }

      .preview-disabled-badge {
        display: none;
        background: #fee2e2;
        color: var(--panel-danger);
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
      }

      .preview-section.is-disabled .preview-disabled-badge {
        display: inline-block;
      }

      .preview-section-body {
        font-size: 12px;
        color: #111827;
      }

      .preview-row {
        margin-bottom: 4px;
      }

      .preview-list-inline {
        margin: 6px 0 0;
        padding-left: 16px;
      }

      .media-preview {
        margin-top: 6px;
        padding: 6px;
        border-radius: 10px;
        border: 1px dashed var(--panel-border);
        background: #f8fafc;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .media-preview img {
        max-height: 64px;
        max-width: 160px;
        object-fit: contain;
        border-radius: 6px;
      }

      .empty-state {
        padding: 40px;
        text-align: center;
        border-radius: 18px;
        border: 1px dashed var(--panel-soft-border);
        background: #f9fbff;
      }

      .empty-state h4 {
        font-weight: 700;
      }

      .form-section {
        border-radius: 12px;
        border: 1px solid var(--panel-border);
        padding: 16px;
        margin-bottom: 18px;
      }

      .form-section-title {
        font-weight: 700;
        margin-bottom: 8px;
      }

      .list-group-item small {
        color: var(--panel-muted);
      }

      .toolbar-help {
        font-size: 12px;
        color: var(--panel-muted);
      }

      .btn-ghost {
        border: 1px solid var(--panel-border);
        background: #fff;
      }

      .editor-entity-section {
        background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%);
        border-color: #dce6f5;
      }

      .entity-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }

      .entity-mode-badge {
        background: #eef4ff;
        border: 1px solid #d7e5ff;
        color: #1d4e89;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 700;
        padding: 4px 10px;
        white-space: nowrap;
      }

      .entity-form {
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: #fff;
        padding: 12px;
      }

      .entity-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        flex-wrap: wrap;
      }

      .entity-item {
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: #fff;
        padding: 10px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .entity-main {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .entity-thumb-wrap {
        width: 44px;
        height: 44px;
        border: 1px solid var(--panel-border);
        border-radius: 10px;
        background: #f9fbff;
        flex: 0 0 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .entity-thumb {
        width: 36px;
        height: 36px;
        object-fit: contain;
      }

      .entity-thumb-placeholder {
        color: var(--panel-muted);
        font-size: 16px;
      }

      .entity-text {
        min-width: 0;
      }

      .entity-title {
        font-weight: 700;
        line-height: 1.2;
      }

      .entity-meta {
        color: var(--panel-muted);
        font-size: 12px;
        margin-top: 2px;
      }

      .entity-item-actions {
        display: flex;
        gap: 6px;
        align-items: center;
        flex: 0 0 auto;
      }

      .entity-order-handle {
        cursor: grab;
        background: #f8fafc;
      }

      .entity-order-handle:active {
        cursor: grabbing;
      }

      .entity-inline-icon {
        width: 22px;
        height: 22px;
        border-radius: 6px;
        border: 1px solid var(--panel-border);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #1d4e89;
        background: #f8fbff;
        flex: 0 0 22px;
      }

      .hero-icon-controls {
        display: flex;
        gap: 8px;
        flex-wrap: nowrap;
      }

      .hero-icon-selected {
        margin-top: 8px;
        border: 1px solid var(--panel-border);
        border-radius: 8px;
        padding: 6px 10px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #1d4e89;
        background: #f8fbff;
        max-width: 240px;
      }

      .hero-icon-selected i {
        font-size: 16px;
      }

      .hero-icon-selected.is-empty {
        color: var(--panel-muted);
        background: #f9fafb;
      }

      .hero-icon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 10px;
      }

      .hero-icon-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: 90px;
      }

      .hero-icon-option i {
        font-size: 20px;
      }

      .hero-inline-actions {
        width: 100%;
        justify-content: flex-end;
      }

      .hero-media-layout {
        align-items: flex-start;
      }

      .hero-media-help {
        max-width: 420px;
      }

      .hero-media-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 2px;
        padding-top: 10px;
        border-top: 1px dashed var(--panel-border);
      }

      .overview-editor-section .entity-header {
        margin-bottom: 12px;
      }

      .overview-form-actions {
        margin-top: 12px;
        padding-top: 10px;
        border-top: 1px dashed var(--panel-border);
      }

      .overview-quill .ql-editor {
        min-height: 120px;
        max-height: 220px;
        overflow-y: auto;
      }

      .overview-answer-editor .ql-editor {
        min-height: 150px;
      }

      .overview-list-wrap {
        border-top: 1px solid #eef2f8;
        padding-top: 12px;
      }

      .overview-list-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 6px;
      }

      .overview-item-list .list-group-item {
        padding: 10px 0;
      }

      .overview-item-card {
        align-items: flex-start;
        gap: 12px;
      }

      .overview-item-card .entity-main {
        align-items: flex-start;
        gap: 10px;
        flex: 1;
      }

      .overview-item-badge {
        width: 36px;
        height: 36px;
        flex: 0 0 36px;
        border-radius: 10px;
        font-size: 15px;
        color: #1d4e89;
        background: #f4f8ff;
      }

      .overview-item-text {
        min-width: 0;
      }

      .overview-item-question {
        margin-bottom: 4px;
      }

      .overview-item-answer {
        color: var(--panel-muted);
        font-size: 13px;
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      @media (max-width: 768px) {
        .hero-icon-controls {
          flex-wrap: wrap;
        }

        .hero-inline-actions {
          justify-content: flex-start;
        }

        .hero-media-actions {
          justify-content: flex-start;
        }

        .overview-list-head {
          align-items: flex-start;
          flex-direction: column;
        }

        .overview-form-actions {
          justify-content: flex-start;
        }
      }

      .entity-list .list-group-item {
        padding: 12px 0;
        border-color: #eef2f8;
      }

      .entity-tags {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 5px;
      }

      .entity-tag {
        background: #eef4ff;
        border: 1px solid #d9e7ff;
        color: #1d4e89;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 8px;
      }

      .entity-url {
        color: var(--panel-muted);
        font-size: 12px;
        max-width: 260px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .entity-empty-state {
        border: 1px dashed var(--panel-soft-border);
        border-radius: 12px;
        background: #fbfdff;
        color: var(--panel-muted);
        text-align: center;
        padding: 14px 12px;
        font-size: 13px;
      }

      .badge-soft {
        background: rgba(15, 76, 129, 0.1);
        color: var(--panel-accent);
        border-radius: 999px;
        font-size: 11px;
        padding: 4px 8px;
      }

      @media (max-width: 1200px) {
        .editor-layout {
          grid-template-columns: 1fr;
        }

        .preview-card {
          position: static;
        }
      }

      @media (max-width: 991px) {
        .editor-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .entity-header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid px-4">
        <a class="navbar-brand fs-4" href="#">
          <i class="bi bi-mortarboard-fill me-2"></i>WhiteScholars Admin
        </a>
        <a href="{% url 'logout' %}" class="btn btn-outline-light btn-sm">
          <i class="bi bi-box-arrow-right"></i> Logout
        </a>
      </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080" data-toast-container>
          {% if messages %}
          {% for message in messages %}
            {% with tag=message.tags|default:'info' %}
              <div
                class="toast align-items-center border-0 {% if 'error' in tag %}text-bg-danger{% elif 'success' in tag %}text-bg-success{% elif 'warning' in tag %}text-bg-warning{% else %}text-bg-info{% endif %}"
                role="alert"
                aria-live="assertive"
                aria-atomic="true"
                data-bs-autohide="{% if 'error' in tag %}false{% else %}true{% endif %}"
                data-bs-delay="{% if 'error' in tag %}0{% else %}5000{% endif %}"
              >
                <div class="d-flex">
                  <div class="toast-body">{{ message }}</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
              </div>
            {% endwith %}
          {% endfor %}
          {% endif %}
        </div>

      <div class="required-hint">
        Only fields marked with <strong>*</strong> are mandatory. Alt text fields are optional.
      </div>

      <div class="row g-4">
        <aside class="col-xl-3 col-lg-4">
          <div class="panel">
            <div class="panel-header">
              <div>
                <p class="panel-title">Courses</p>
                <p class="panel-subtitle">Select a course to edit or create a new one.</p>
              </div>
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#courseModal">
                <i class="bi bi-plus"></i> New
              </button>
            </div>
            <div class="course-list">
              {% for course in courses %}
                <a
                  class="course-item {% if selected_course and selected_course.id == course.id %}active{% endif %}"
                  href="{% url 'dashboard_course' course.slug %}"
                >
                  <span class="course-name">{{ course.name }}</span>
                  <span class="course-slug">{{ course.slug }}</span>
                </a>
              {% empty %}
                <div class="text-center text-muted py-4">
                  No courses yet. Create your first course.
                </div>
              {% endfor %}
            </div>
          </div>
        </aside>

        <main class="col-xl-9 col-lg-8">
          {% if not selected_course %}
            <div class="empty-state">
              <h4>Create your first course</h4>
              <p class="text-muted">Add a course to start building the content for your landing page.</p>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#courseModal">
                Add Course
              </button>
            </div>
          {% else %}
            <div class="editor-header">
              <div>
                <h2>{{ selected_course.name }}</h2>
                <div class="meta">Slug: {{ selected_course.slug }}</div>
              </div>
              <div class="d-flex gap-2 flex-wrap">
                <a class="btn btn-outline-secondary" href="{% url 'course-page' selected_course.slug %}" target="_blank">
                  View API Payload
                </a>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#courseEditModal">
                  Edit Course
                </button>
              </div>
            </div>

            <div class="editor-layout">
              <div>
                <div class="panel mb-4">
                  <div class="panel-header">
                    <div>
                      <p class="panel-title">Course SEO & Assets</p>
                      <p class="panel-subtitle">Meta tags, OG image, brochure PDF.</p>
                    </div>
                    <span class="badge-soft">Step 1</span>
                  </div>
                  <form method="POST" enctype="multipart/form-data" action="{% url 'dashboard' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_course_meta" />
                    <input type="hidden" name="course" value="{{ selected_course.id }}" />
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Course Name</label>
                        <input type="text" class="form-control" name="name" value="{{ selected_course.name }}" required />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Slug</label>
                        <input type="text" class="form-control" name="slug" value="{{ selected_course.slug }}" />
                      </div>
                      <div class="col-12">
                        <label class="form-label">Meta Title</label>
                        <input type="text" class="form-control" name="meta_title" value="{{ selected_course.meta_title|default:'' }}" />
                      </div>
                      <div class="col-12">
                        <label class="form-label">Meta Description</label>
                        <textarea class="form-control" name="meta_description" rows="2">{{ selected_course.meta_description|default:'' }}</textarea>
                      </div>
                      <div class="col-12">
                        <label class="form-label">Meta Keywords</label>
                        <input type="text" class="form-control" name="meta_keywords" value="{{ selected_course.meta_keywords|default:'' }}" />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">OG Image</label>
                        <input type="file" class="form-control" name="meta_og_image" accept="image/*" />
                        {% if selected_course.meta_og_image %}
                          <small class="text-muted">Current: {{ selected_course.meta_og_image.url }}</small>
                        {% endif %}
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Brochure PDF</label>
                        <input type="file" class="form-control" name="brochure_pdf" accept="application/pdf" />
                        {% if selected_course.brochure_pdf %}
                          <small class="text-muted">Current: {{ selected_course.brochure_pdf.url }}</small>
                        {% endif %}
                      </div>
                    </div>
                    <div class="mt-3 text-end">
                      <button class="btn btn-primary" type="submit">Save Course Settings</button>
                    </div>
                  </form>
                </div>

                <div class="panel mb-4">
                  <div class="panel-header">
                    <div>
                      <p class="panel-title">Popup Modal (Lead Form)</p>
                      <p class="panel-subtitle">This modal opens when a button action is set to Modal.</p>
                    </div>
                    <span class="badge-soft">Step 2</span>
                  </div>
                  <form method="POST" enctype="multipart/form-data" action="{% url 'dashboard' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_popup_modal" />
                    <input type="hidden" name="course" value="{{ selected_course.id }}" />
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Popup Heading</label>
                        <input
                          type="text"
                          class="form-control"
                          name="popup_heading"
                          placeholder="Still confused of what course to take? Let us help you!"
                          value="{{ popup_modal.heading|default:'' }}"
                          required
                        />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Popup Image</label>
                        <input type="file" class="form-control" name="popup_image" accept="image/*" {% if not popup_modal.image %}required{% endif %} />
                        {% if popup_modal.image %}
                          <div class="media-preview">
                            <img src="{{ popup_modal.image.url }}" alt="{{ popup_modal.image_alt|default:'Popup image' }}" />
                            <small class="text-muted">{{ popup_modal.image_alt|default:'Popup image' }}</small>
                          </div>
                        {% endif %}
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Image Alt Text</label>
                        <input
                          type="text"
                          class="form-control"
                          name="popup_image_alt"
                          placeholder="Counselor pointing at charts"
                          value="{{ popup_modal.image_alt|default:'' }}"
                        />
                      </div>
                    </div>
                    <div class="mt-3 text-end">
                      <button class="btn btn-primary" type="submit">Save Popup</button>
                    </div>
                  </form>
                </div>

                <div class="section-list" id="section-list">
                  {% for section in course_sections %}
                    <div class="section-card" data-section-key="{{ section.key }}">
                      <div class="section-header" data-bs-toggle="collapse" data-bs-target="#section-{{ section.key }}">
                        <div class="drag-handle"><i class="bi bi-grip-vertical"></i></div>
                        <div class="section-info">
                          <div class="section-title">{{ section.label }}</div>
                          <div class="section-desc">{{ section.description }}</div>
                        </div>
                        <div class="section-actions">
                          <div class="form-check form-switch m-0">
                            <input
                              class="form-check-input section-toggle"
                              type="checkbox"
                              data-section-key="{{ section.key }}"
                              {% if section.is_enabled %}checked{% endif %}
                            />
                          </div>
                          <i class="bi bi-chevron-down"></i>
                        </div>
                      </div>
                      <div class="accordion-collapse collapse {% if active_section == section.key %}show{% endif %}" id="section-{{ section.key }}">
                        <div class="section-body">
                          {% if section.key == 'cta_ready' %}
                            {% include 'components/editor_sections/cta.html' with cta_key='ready' cta_label='Ready to Start' cta_instance=lead_ctas.ready %}
                          {% elif section.key == 'cta_discover' %}
                            {% include 'components/editor_sections/cta.html' with cta_key='discover' cta_label='Discover Secrets' cta_instance=lead_ctas.discover %}
                          {% elif section.key == 'cta_confused' %}
                            {% include 'components/editor_sections/cta.html' with cta_key='confused' cta_label='Still Confused' cta_instance=lead_ctas.confused %}
                          {% else %}
                            {% include section.template %}
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>

              <aside>
                <div class="preview-card">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <h6 class="mb-1">Preview</h6>
                      <p class="editor-note mb-0">Shows saved content. Save a section to refresh this view.</p>
                    </div>
                  </div>
                  <ul class="nav nav-pills preview-tabs" id="previewTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button
                        class="nav-link active"
                        id="preview-structure-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#preview-structure"
                        type="button"
                        role="tab"
                      >
                        Structure
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button
                        class="nav-link"
                        id="preview-content-tab"
                        data-bs-toggle="tab"
                        data-bs-target="#preview-content"
                        type="button"
                        role="tab"
                      >
                        Content
                      </button>
                    </li>
                  </ul>
                  <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="preview-structure" role="tabpanel">
                      <ul class="preview-list" data-preview-structure>
                        {% for section in course_sections %}
                          <li
                            class="preview-item {% if not section.is_enabled %}disabled{% endif %}"
                            data-section-key="{{ section.key }}"
                          >
                            {{ section.label }}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                    <div class="tab-pane fade" id="preview-content" role="tabpanel">
                      {% include 'components/course_preview.html' %}
                    </div>
                  </div>
                </div>
              </aside>
            </div>
          {% endif %}
        </main>
      </div>
    </div>
    <div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form method="POST" enctype="multipart/form-data" action="{% url 'add_course' %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="dashboard" />
            <div class="modal-header">
              <h5 class="modal-title">Add New Course</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Course Name</label>
                  <input type="text" class="form-control" name="name" id="course-name" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Slug</label>
                  <input type="text" class="form-control" name="slug" id="course-slug" />
                  <div class="editor-note">Leave blank to auto-generate.</div>
                </div>
                <div class="col-12">
                  <label class="form-label">Meta Title</label>
                  <input type="text" class="form-control" name="meta_title" />
                </div>
                <div class="col-12">
                  <label class="form-label">Meta Description</label>
                  <textarea class="form-control" name="meta_description" rows="2"></textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">Meta Keywords</label>
                  <input type="text" class="form-control" name="meta_keywords" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">OG Image</label>
                  <input type="file" class="form-control" name="meta_og_image" accept="image/*" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Brochure PDF</label>
                  <input type="file" class="form-control" name="brochure_pdf" accept="application/pdf" />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Create Course</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% if selected_course %}
    <div class="modal fade" id="courseEditModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form method="POST" enctype="multipart/form-data" action="{% url 'edit_course' selected_course.id %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="dashboard" />
            <div class="modal-header">
              <h5 class="modal-title">Edit Course</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Course Name</label>
                  <input type="text" class="form-control" name="name" value="{{ selected_course.name }}" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Slug</label>
                  <input type="text" class="form-control" name="slug" value="{{ selected_course.slug }}" />
                </div>
                <div class="col-12">
                  <label class="form-label">Meta Title</label>
                  <input type="text" class="form-control" name="meta_title" value="{{ selected_course.meta_title|default:'' }}" />
                </div>
                <div class="col-12">
                  <label class="form-label">Meta Description</label>
                  <textarea class="form-control" name="meta_description" rows="2">{{ selected_course.meta_description|default:'' }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">Meta Keywords</label>
                  <input type="text" class="form-control" name="meta_keywords" value="{{ selected_course.meta_keywords|default:'' }}" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">OG Image</label>
                  <input type="file" class="form-control" name="meta_og_image" accept="image/*" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Brochure PDF</label>
                  <input type="file" class="form-control" name="brochure_pdf" accept="application/pdf" />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
      const getCookie = (name) => {
        const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        return match ? decodeURIComponent(match[2]) : '';
      };
      const csrfToken =
        document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
      const dashboardUrl = new URL("{% url 'dashboard' %}", window.location.origin);
      const dashboardPath = dashboardUrl.pathname;
      const selectedCourseId = '{{ selected_course.id|default:"" }}';
      const quillEditors = [];
      const boundDashboardForms = new WeakSet();

      const getToastContainer = () => {
        let container = document.querySelector('[data-toast-container]');
        if (!container) {
          container = document.createElement('div');
          container.className = 'toast-container position-fixed top-0 end-0 p-3';
          container.style.zIndex = '1080';
          container.setAttribute('data-toast-container', '');
          document.body.appendChild(container);
        }
        return container;
      };

      const getToastClass = (level) => {
        if (level === 'success') return 'text-bg-success';
        if (level === 'error') return 'text-bg-danger';
        if (level === 'warning') return 'text-bg-warning';
        return 'text-bg-info';
      };

      const showToast = (message, level = 'info') => {
        const normalizedLevel = ['success', 'error', 'warning', 'info'].includes(level) ? level : 'info';
        const autohide = normalizedLevel !== 'error';
        const delay = normalizedLevel === 'success' ? 4000 : 5000;
        const container = getToastContainer();

        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center border-0 ${getToastClass(normalizedLevel)}`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.setAttribute('data-bs-autohide', autohide ? 'true' : 'false');
        toastEl.setAttribute('data-bs-delay', autohide ? String(delay) : '0');
        toastEl.innerHTML =
          '<div class="d-flex">' +
          '<div class="toast-body"></div>' +
          '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>' +
          '</div>';
        toastEl.querySelector('.toast-body').textContent = message;

        container.appendChild(toastEl);
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        const toast = bootstrap.Toast.getOrCreateInstance(toastEl, { autohide, delay });
        toast.show();
      };

      const escapeHtml = (value) =>
        String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const escapeAttr = (value) => escapeHtml(value);
      const toTitle = (value) =>
        String(value ?? '')
          .replace(/_/g, ' ')
          .replace(/\b\w/g, (char) => char.toUpperCase());

      const createHeroLogoItemMarkup = (item) => {
        const label = item.image_alt || 'Logo';
        const thumb = item.image_url
          ? `<img src="${escapeAttr(item.image_url)}" alt="${escapeAttr(label)}" class="entity-thumb" />`
          : '<span class="entity-thumb-placeholder"><i class="bi bi-image"></i></span>';
        return (
          `<div class="col-md-6" data-hero-logo-item="${escapeAttr(item.id)}">` +
          '<article class="entity-item">' +
          '<div class="entity-main">' +
          `<div class="entity-thumb-wrap">${thumb}</div>` +
          '<div class="entity-text">' +
          `<div class="entity-title text-truncate" data-hero-logo-label>${escapeHtml(label)}</div>` +
          `<div class="entity-meta">Logo ID #${escapeHtml(item.id)}</div>` +
          '</div>' +
          '</div>' +
          '<div class="entity-item-actions">' +
          '<button type="button" class="btn btn-sm btn-light entity-order-handle" data-hero-logo-handle title="Drag to reorder" aria-label="Drag to reorder logo"><i class="bi bi-grip-vertical"></i></button>' +
          `<button type="button" class="btn btn-sm btn-outline-secondary" data-hero-logo-edit data-item-id="${escapeAttr(item.id)}" data-image-alt="${escapeAttr(item.image_alt || '')}" data-image-url="${escapeAttr(item.image_url || '')}" title="Edit logo" aria-label="Edit logo"><i class="bi bi-pencil"></i></button>` +
          `<form method="POST" action="${dashboardPath}" class="d-inline">` +
          `<input type="hidden" name="csrfmiddlewaretoken" value="${escapeAttr(csrfToken)}" />` +
          '<input type="hidden" name="action" value="delete_hero_logo" />' +
          `<input type="hidden" name="course" value="${escapeAttr(selectedCourseId)}" />` +
          `<input type="hidden" name="item_id" value="${escapeAttr(item.id)}" />` +
          '<button class="btn btn-sm btn-outline-danger" type="submit" title="Delete logo" aria-label="Delete logo"><i class="bi bi-trash"></i></button>' +
          '</form>' +
          '</div>' +
          '</article>' +
          '</div>'
        );
      };

      const createHeroButtonItemMarkup = (item) => {
        const iconClass = String(item.icon_class || '').trim();
        const iconTag = iconClass
          ? `<span class="entity-inline-icon"><i class="bi ${escapeAttr(iconClass)}"></i></span>`
          : '';
        const urlTag = item.action_type === 'link' && item.url
          ? `<span class="entity-url" title="${escapeAttr(item.url)}">${escapeHtml(item.url)}</span>`
          : '';
        return (
          `<li class="list-group-item d-flex align-items-center justify-content-between" data-hero-button-item="${escapeAttr(item.id)}">` +
          '<div class="pe-3">' +
          `<div class="entity-title d-flex align-items-center gap-2" data-hero-button-label>${iconTag}<span>${escapeHtml(item.label || '')}</span></div>` +
          '<div class="entity-tags">' +
          `<span class="entity-tag">${escapeHtml(toTitle(item.style || ''))}</span>` +
          `<span class="entity-tag">${escapeHtml(toTitle(item.action_type || ''))}</span>` +
          `${urlTag}` +
          '</div>' +
          '</div>' +
          '<div class="entity-item-actions" role="group" aria-label="Hero CTA actions">' +
          '<button type="button" class="btn btn-sm btn-light entity-order-handle" data-hero-button-handle title="Drag to reorder" aria-label="Drag to reorder button"><i class="bi bi-grip-vertical"></i></button>' +
          `<button type="button" class="btn btn-sm btn-outline-secondary" data-hero-button-edit data-item-id="${escapeAttr(item.id)}" data-label="${escapeAttr(item.label || '')}" data-action-type="${escapeAttr(item.action_type || 'link')}" data-url="${escapeAttr(item.url || '')}" data-style="${escapeAttr(item.style || 'primary')}" data-icon-class="${escapeAttr(item.icon_class || '')}" title="Edit button" aria-label="Edit button"><i class="bi bi-pencil"></i></button>` +
          `<form method="POST" action="${dashboardPath}" class="d-inline">` +
          `<input type="hidden" name="csrfmiddlewaretoken" value="${escapeAttr(csrfToken)}" />` +
          '<input type="hidden" name="action" value="delete_hero_button" />' +
          `<input type="hidden" name="course" value="${escapeAttr(selectedCourseId)}" />` +
          `<input type="hidden" name="item_id" value="${escapeAttr(item.id)}" />` +
          '<button class="btn btn-sm btn-outline-danger" type="submit" title="Delete button" aria-label="Delete button"><i class="bi bi-trash"></i></button>' +
          '</form>' +
          '</div>' +
          '</li>'
        );
      };

      const htmlToPlainTextPreview = (html, maxLength = 160) => {
        const temp = document.createElement('div');
        temp.innerHTML = String(html || '');
        const text = (temp.textContent || temp.innerText || '').replace(/\s+/g, ' ').trim();
        if (!text) return 'No answer text.';
        if (text.length <= maxLength) return text;
        return `${text.slice(0, Math.max(0, maxLength - 3)).trim()}...`;
      };

      const setQuillEditorHtml = (targetId, html) => {
        const hiddenInput = document.getElementById(targetId);
        if (hiddenInput) {
          hiddenInput.value = html || '';
        }
        const entry = quillEditors.find((editor) => editor.hiddenInput && editor.hiddenInput.id === targetId);
        if (entry) {
          entry.quill.root.innerHTML = html || '';
        }
      };

      const createOverviewItemMarkup = (item) => {
        const answerHtml = String(item.answer_html || '');
        return (
          `<li class="list-group-item" data-overview-item="${escapeAttr(item.id)}">` +
          '<article class="entity-item overview-item-card">' +
          '<div class="entity-main">' +
          '<div class="entity-thumb-wrap overview-item-badge" aria-hidden="true"><i class="bi bi-question-circle"></i></div>' +
          '<div class="overview-item-text">' +
          `<div class="entity-title overview-item-question">${escapeHtml(item.question || '')}</div>` +
          `<div class="overview-item-answer">${escapeHtml(htmlToPlainTextPreview(answerHtml))}</div>` +
          '</div>' +
          '</div>' +
          '<div class="entity-item-actions" role="group" aria-label="Overview question actions">' +
          `<button type="button" class="btn btn-sm btn-outline-secondary" data-overview-item-edit data-item-id="${escapeAttr(item.id)}" data-question="${escapeAttr(item.question || '')}" data-answer-html="${escapeAttr(answerHtml)}" title="Edit question" aria-label="Edit question"><i class="bi bi-pencil"></i></button>` +
          `<form method="POST" action="${dashboardPath}" class="d-inline">` +
          `<input type="hidden" name="csrfmiddlewaretoken" value="${escapeAttr(csrfToken)}" />` +
          '<input type="hidden" name="action" value="delete_course_overview_item" />' +
          `<input type="hidden" name="course" value="${escapeAttr(selectedCourseId)}" />` +
          `<input type="hidden" name="item_id" value="${escapeAttr(item.id)}" />` +
          '<button class="btn btn-sm btn-outline-danger" type="submit" title="Delete question" aria-label="Delete question"><i class="bi bi-trash"></i></button>' +
          '</form>' +
          '</div>' +
          '</article>' +
          '</li>'
        );
      };

      const ensureOverviewItemsEmptyState = () => {
        const list = document.querySelector('[data-overview-items-list]');
        if (!list) return;
        const itemCount = list.querySelectorAll('[data-overview-item]').length;
        let empty = list.querySelector('[data-overview-items-empty]');
        if (itemCount === 0 && !empty) {
          list.insertAdjacentHTML(
            'beforeend',
            '<li class="list-group-item" data-overview-items-empty><div class="entity-empty-state">No overview questions yet. Add your first question above.</div></li>'
          );
          empty = list.querySelector('[data-overview-items-empty]');
        }
        if (itemCount > 0 && empty) {
          empty.remove();
        }

        const badge = document.querySelector('.overview-list-head .badge-soft');
        if (badge) {
          badge.textContent = `${itemCount} item${itemCount === 1 ? '' : 's'}`;
        }
      };

      const ensureHeroLogosEmptyState = () => {
        const list = document.querySelector('[data-hero-logos-list]');
        if (!list) return;
        const itemCount = list.querySelectorAll('[data-hero-logo-item]').length;
        let empty = list.querySelector('[data-hero-logos-empty]');
        if (itemCount === 0 && !empty) {
          list.insertAdjacentHTML(
            'beforeend',
            '<div class="col-12" data-hero-logos-empty><div class="entity-empty-state">No collaboration logos yet. Add your first partner logo above.</div></div>'
          );
          return;
        }
        if (itemCount > 0 && empty) {
          empty.remove();
        }
      };

      const ensureHeroButtonsEmptyState = () => {
        const list = document.querySelector('[data-hero-buttons-list]');
        if (!list) return;
        const itemCount = list.querySelectorAll('[data-hero-button-item]').length;
        let empty = list.querySelector('[data-hero-buttons-empty]');
        if (itemCount === 0 && !empty) {
          list.insertAdjacentHTML(
            'beforeend',
            '<li class="list-group-item" data-hero-buttons-empty><div class="entity-empty-state">No CTA buttons yet. Add your first hero CTA above.</div></li>'
          );
          return;
        }
        if (itemCount > 0 && empty) {
          empty.remove();
        }
      };

      const setHeroButtonIconSelection = (iconClass, iconLabel = '') => {
        const form = document.querySelector('[data-hero-button-form]');
        if (!form) return;

        const valueInput = form.querySelector('[data-hero-button-icon-value]');
        if (valueInput) {
          valueInput.value = iconClass || '';
        }

        const preview = form.querySelector('[data-hero-button-icon-preview]');
        if (!preview) return;

        document.querySelectorAll('[data-hero-icon-option]').forEach((option) => {
          option.classList.toggle('active', (option.dataset.heroIconOption || '') === (iconClass || ''));
        });

        if (iconClass) {
          preview.classList.remove('is-empty');
          preview.innerHTML = `<i class="bi ${escapeAttr(iconClass)}"></i><span>${escapeHtml(iconLabel || 'Icon selected')}</span>`;
          return;
        }

        preview.classList.add('is-empty');
        preview.innerHTML = '<i class="bi bi-slash-circle"></i><span>No icon selected</span>';
      };

      const resetHeroLogoFormToAddMode = () => {
        const form = document.querySelector('[data-hero-logo-form]');
        if (!form) return;
        form.reset();
        const itemId = form.querySelector('[data-hero-logo-item-id]');
        if (itemId) itemId.value = '';
        const imageInput = form.querySelector('[data-hero-logo-image]');
        if (imageInput) {
          imageInput.value = '';
          imageInput.required = true;
        }
        const altInput = form.querySelector('[data-hero-logo-alt]');
        if (altInput) altInput.value = '';
        const submitButton = form.querySelector('[data-hero-logo-submit]');
        if (submitButton) submitButton.textContent = 'Add Logo';
        const modeBadge = document.querySelector('[data-hero-logo-mode]');
        if (modeBadge) modeBadge.textContent = 'Add new logo';
        const cancelButton = form.querySelector('[data-hero-logo-cancel]');
        if (cancelButton) {
          cancelButton.classList.add('d-none');
        }
      };

      const resetHeroButtonFormToAddMode = () => {
        const form = document.querySelector('[data-hero-button-form]');
        if (!form) return;
        form.reset();
        const itemId = form.querySelector('[data-hero-button-item-id]');
        if (itemId) itemId.value = '';
        const labelInput = form.querySelector('input[name="label"]');
        if (labelInput) labelInput.value = '';
        const actionSelect = form.querySelector('[data-action-select]');
        if (actionSelect) actionSelect.value = 'link';
        const urlInput = form.querySelector('input[name="url"]');
        if (urlInput) urlInput.value = '';
        const styleSelect = form.querySelector('select[name="style"]');
        if (styleSelect) styleSelect.value = 'primary';
        const submitButton = form.querySelector('[data-hero-button-submit]');
        if (submitButton) submitButton.textContent = 'Add Button';
        const modeBadge = document.querySelector('[data-hero-button-mode]');
        if (modeBadge) modeBadge.textContent = 'Add new button';
        const cancelButton = form.querySelector('[data-hero-button-cancel]');
        if (cancelButton) {
          cancelButton.classList.add('d-none');
        }
        if (actionSelect) updateActionVisibility(actionSelect);
        setHeroButtonIconSelection('', '');
      };

      const resetOverviewItemFormToAddMode = () => {
        const form = document.querySelector('[data-overview-item-form]');
        if (!form) return;
        form.reset();
        const itemId = form.querySelector('[data-overview-item-id]');
        if (itemId) itemId.value = '';
        const questionInput = form.querySelector('[data-overview-question-input]');
        if (questionInput) questionInput.value = '';
        setQuillEditorHtml('overview-answer-html', '');
        const submitButton = form.querySelector('[data-overview-item-submit]');
        if (submitButton) submitButton.textContent = 'Add Question';
        const modeBadge = document.querySelector('[data-overview-item-mode]');
        if (modeBadge) modeBadge.textContent = 'Add question';
        const cancelButton = form.querySelector('[data-overview-item-cancel]');
        if (cancelButton) cancelButton.classList.add('d-none');
      };

      const startHeroLogoEdit = (button) => {
        const form = document.querySelector('[data-hero-logo-form]');
        if (!form || !button) return;
        const itemId = form.querySelector('[data-hero-logo-item-id]');
        const imageInput = form.querySelector('[data-hero-logo-image]');
        const altInput = form.querySelector('[data-hero-logo-alt]');
        const submitButton = form.querySelector('[data-hero-logo-submit]');
        const modeBadge = document.querySelector('[data-hero-logo-mode]');
        const cancelButton = form.querySelector('[data-hero-logo-cancel]');

        if (itemId) itemId.value = button.dataset.itemId || '';
        if (altInput) altInput.value = button.dataset.imageAlt || '';
        if (imageInput) imageInput.required = false;
        if (submitButton) submitButton.textContent = 'Update Logo';
        if (modeBadge) modeBadge.textContent = 'Editing logo';
        if (cancelButton) cancelButton.classList.remove('d-none');
      };

      const startHeroButtonEdit = (button) => {
        const form = document.querySelector('[data-hero-button-form]');
        if (!form || !button) return;
        const itemId = form.querySelector('[data-hero-button-item-id]');
        const labelInput = form.querySelector('input[name="label"]');
        const actionSelect = form.querySelector('[data-action-select]');
        const urlInput = form.querySelector('input[name="url"]');
        const styleSelect = form.querySelector('select[name="style"]');
        const submitButton = form.querySelector('[data-hero-button-submit]');
        const modeBadge = document.querySelector('[data-hero-button-mode]');
        const cancelButton = form.querySelector('[data-hero-button-cancel]');
        const iconClass = button.dataset.iconClass || '';

        if (itemId) itemId.value = button.dataset.itemId || '';
        if (labelInput) labelInput.value = button.dataset.label || '';
        if (actionSelect) {
          actionSelect.value = button.dataset.actionType || 'link';
          updateActionVisibility(actionSelect);
        }
        if (urlInput) urlInput.value = button.dataset.url || '';
        if (styleSelect) styleSelect.value = button.dataset.style || 'primary';
        setHeroButtonIconSelection(iconClass, getHeroIconLabel(iconClass));
        if (submitButton) submitButton.textContent = 'Update Button';
        if (modeBadge) modeBadge.textContent = 'Editing button';
        if (cancelButton) cancelButton.classList.remove('d-none');
      };

      const startOverviewItemEdit = (button) => {
        const form = document.querySelector('[data-overview-item-form]');
        if (!form || !button) return;
        const itemId = form.querySelector('[data-overview-item-id]');
        const questionInput = form.querySelector('[data-overview-question-input]');
        const submitButton = form.querySelector('[data-overview-item-submit]');
        const cancelButton = form.querySelector('[data-overview-item-cancel]');
        const modeBadge = document.querySelector('[data-overview-item-mode]');

        if (itemId) itemId.value = button.dataset.itemId || '';
        if (questionInput) questionInput.value = button.dataset.question || '';
        setQuillEditorHtml('overview-answer-html', button.dataset.answerHtml || '');
        if (submitButton) submitButton.textContent = 'Update Question';
        if (modeBadge) modeBadge.textContent = 'Editing question';
        if (cancelButton) cancelButton.classList.remove('d-none');
        form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      };

      const bindDashboardForm = (form) => {
        if (!isDashboardEditorForm(form) || boundDashboardForms.has(form)) return;
        boundDashboardForms.add(form);
        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          syncFormQuillEditors(form);

          const submitButtons = form.querySelectorAll('button[type="submit"], input[type="submit"]');
          submitButtons.forEach((button) => {
            button.disabled = true;
          });

          try {
            const response = await fetch(form.getAttribute('action') || window.location.href, {
              method: 'POST',
              body: new FormData(form),
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
              },
            });

            let payload = null;
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
              payload = await response.json();
            }

            if (payload && Array.isArray(payload.messages) && payload.messages.length) {
              payload.messages.forEach((entry) => {
                showToast(entry.text, entry.level);
              });
            } else if (response.ok) {
              showToast('Data saved successfully.', 'success');
            } else {
              showToast('Unable to save changes. Please check the form and try again.', 'error');
            }

            const formAction = form.querySelector('input[name="action"]')?.value || '';
            if (response.ok && formAction === 'clear_edit_context') {
              if (payload && payload.redirect_url) {
                window.location.assign(payload.redirect_url);
              } else {
                window.location.reload();
              }
              return;
            }

            if (response.ok && payload && payload.data) {
              const action = payload.data.action;
              if (action === 'save_hero_logo' && payload.data.item) {
                const list = document.querySelector('[data-hero-logos-list]');
                if (list) {
                  const itemSelector = `[data-hero-logo-item="${payload.data.item.id}"]`;
                  const existingItem = list.querySelector(itemSelector);
                  if (existingItem) {
                    existingItem.outerHTML = createHeroLogoItemMarkup(payload.data.item);
                  } else {
                    list.insertAdjacentHTML('beforeend', createHeroLogoItemMarkup(payload.data.item));
                  }
                  ensureHeroLogosEmptyState();
                  bindDashboardForms(list);
                }
                resetHeroLogoFormToAddMode();
              }

              if (action === 'delete_hero_logo' && payload.data.item_id) {
                const list = document.querySelector('[data-hero-logos-list]');
                if (list) {
                  const item = list.querySelector(`[data-hero-logo-item="${payload.data.item_id}"]`);
                  if (item) item.remove();
                  ensureHeroLogosEmptyState();
                }
              }

              if (action === 'save_course_overview_item' && payload.data.item) {
                const list = document.querySelector('[data-overview-items-list]');
                if (list) {
                  const itemSelector = `[data-overview-item="${payload.data.item.id}"]`;
                  const existingItem = list.querySelector(itemSelector);
                  if (existingItem) {
                    existingItem.outerHTML = createOverviewItemMarkup(payload.data.item);
                  } else {
                    list.insertAdjacentHTML('beforeend', createOverviewItemMarkup(payload.data.item));
                  }
                  ensureOverviewItemsEmptyState();
                  bindDashboardForms(list);
                }
                resetOverviewItemFormToAddMode();
              }

              if (action === 'delete_course_overview_item' && payload.data.item_id) {
                const list = document.querySelector('[data-overview-items-list]');
                if (list) {
                  const item = list.querySelector(`[data-overview-item="${payload.data.item_id}"]`);
                  if (item) item.remove();
                  ensureOverviewItemsEmptyState();
                }
                const activeItem = document.querySelector('[data-overview-item-id]');
                if (activeItem && String(activeItem.value || '') === String(payload.data.item_id || '')) {
                  resetOverviewItemFormToAddMode();
                }
              }

              if (action === 'save_hero_button' && payload.data.item) {
                const list = document.querySelector('[data-hero-buttons-list]');
                if (list) {
                  const itemSelector = `[data-hero-button-item="${payload.data.item.id}"]`;
                  const existingItem = list.querySelector(itemSelector);
                  if (existingItem) {
                    existingItem.outerHTML = createHeroButtonItemMarkup(payload.data.item);
                  } else {
                    list.insertAdjacentHTML('beforeend', createHeroButtonItemMarkup(payload.data.item));
                  }
                  ensureHeroButtonsEmptyState();
                  bindDashboardForms(list);
                }
                resetHeroButtonFormToAddMode();
              }

              if (action === 'delete_hero_button' && payload.data.item_id) {
                const list = document.querySelector('[data-hero-buttons-list]');
                if (list) {
                  const item = list.querySelector(`[data-hero-button-item="${payload.data.item_id}"]`);
                  if (item) item.remove();
                  ensureHeroButtonsEmptyState();
                }
              }
            }
          } catch (error) {
            showToast('Network error while saving. Please try again.', 'error');
          } finally {
            submitButtons.forEach((button) => {
              button.disabled = false;
            });
          }
        });
      };

      const bindDashboardForms = (scope = document) => {
        scope.querySelectorAll('form').forEach((form) => bindDashboardForm(form));
      };

      const isDashboardEditorForm = (form) => {
        if ((form.method || 'GET').toUpperCase() !== 'POST') return false;
        if (!form.querySelector('input[name="action"]')) return false;
        const actionUrl = new URL(form.getAttribute('action') || window.location.href, window.location.origin);
        return actionUrl.pathname === dashboardUrl.pathname;
      };

      const syncFormQuillEditors = (form) => {
        quillEditors.forEach((editor) => {
          if (editor.form === form) {
            editor.hiddenInput.value = editor.quill.root.innerHTML;
          }
        });
      };

      const slugify = (value) =>
        value
          .toLowerCase()
          .trim()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-');

      const updateActionVisibility = (select) => {
        const scope = select.closest('[data-action-scope]');
        if (!scope) return;
        const linkField = scope.querySelector('[data-action-field="link"]');
        if (!linkField) return;

        const isLink = select.value === 'link';
        linkField.style.display = isLink ? '' : 'none';

        const urlInput = linkField.querySelector('input, textarea, select');
        if (urlInput) {
          urlInput.required = isLink;
        }

        const label = linkField.querySelector('.form-label');
        if (label) {
          label.classList.toggle('required-label', isLink);
        }
      };

      const updateHeroMediaVisibility = (select) => {
        const scope = select.closest('[data-hero-media-scope]');
        if (!scope) return;

        const selectedType = select.value === 'video' ? 'video' : 'image';

        scope.querySelectorAll('[data-hero-media-field]').forEach((field) => {
          field.style.display = field.dataset.heroMediaField === selectedType ? '' : 'none';
        });

        scope.querySelectorAll('[data-hero-media-help]').forEach((note) => {
          note.style.display = note.dataset.heroMediaHelp === selectedType ? '' : 'none';
        });
      };

      const getHeroIconLabel = (iconClass) => {
        if (!iconClass) return '';
        const option = Array.from(document.querySelectorAll('[data-hero-icon-option]')).find(
          (node) => (node.dataset.heroIconOption || '') === iconClass
        );
        return option?.dataset.heroIconLabel || '';
      };

      const initializeHeroAssetSorting = () => {
        const logosList = document.querySelector('[data-hero-logos-list]');
        if (logosList && !logosList.dataset.sortableBound) {
          logosList.dataset.sortableBound = 'true';
          Sortable.create(logosList, {
            handle: '[data-hero-logo-handle]',
            draggable: '[data-hero-logo-item]',
            animation: 150,
            onEnd: async () => {
              const order = Array.from(logosList.querySelectorAll('[data-hero-logo-item]')).map(
                (item) => item.getAttribute('data-hero-logo-item')
              );
              try {
                const response = await fetch("{% url 'reorder_hero_logos' %}", {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                  },
                  body: JSON.stringify({
                    course_id: selectedCourseId,
                    order: order,
                  }),
                });
                if (!response.ok) throw new Error('failed');
                showToast('Logo order updated.', 'success');
              } catch (error) {
                showToast('Unable to update logo order.', 'error');
              }
            },
          });
        }

        const buttonsList = document.querySelector('[data-hero-buttons-list]');
        if (buttonsList && !buttonsList.dataset.sortableBound) {
          buttonsList.dataset.sortableBound = 'true';
          Sortable.create(buttonsList, {
            handle: '[data-hero-button-handle]',
            draggable: '[data-hero-button-item]',
            animation: 150,
            onEnd: async () => {
              const order = Array.from(buttonsList.querySelectorAll('[data-hero-button-item]')).map(
                (item) => item.getAttribute('data-hero-button-item')
              );
              try {
                const response = await fetch("{% url 'reorder_hero_buttons' %}", {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                  },
                  body: JSON.stringify({
                    course_id: selectedCourseId,
                    order: order,
                  }),
                });
                if (!response.ok) throw new Error('failed');
                showToast('Button order updated.', 'success');
              } catch (error) {
                showToast('Unable to update button order.', 'error');
              }
            },
          });
        }
      };

      const reorderPreview = (order) => {
        const reorderContainer = (container, selector) => {
          if (!container) return;
          const items = {};
          container.querySelectorAll(selector).forEach((item) => {
            items[item.dataset.sectionKey] = item;
          });
          const fragment = document.createDocumentFragment();
          order.forEach((key) => {
            if (items[key]) fragment.appendChild(items[key]);
          });
          container.appendChild(fragment);
        };
        reorderContainer(document.querySelector('[data-preview-structure]'), '[data-section-key]');
        reorderContainer(document.querySelector('[data-preview-content]'), '.preview-section');
      };

      const updatePreviewToggle = (key, isEnabled) => {
        document.querySelectorAll(`[data-preview-structure] [data-section-key="${key}"]`).forEach((item) => {
          item.classList.toggle('disabled', !isEnabled);
        });
        document.querySelectorAll(`[data-preview-content] [data-section-key="${key}"]`).forEach((item) => {
          item.classList.toggle('is-disabled', !isEnabled);
        });
      };

      const nameInput = document.getElementById('course-name');
      const slugInput = document.getElementById('course-slug');
      if (nameInput && slugInput) {
        nameInput.addEventListener('input', () => {
          if (!slugInput.value) {
            slugInput.value = slugify(nameInput.value);
          }
        });
      }

      const sectionList = document.getElementById('section-list');
      if (sectionList) {
        Sortable.create(sectionList, {
          handle: '.drag-handle',
          animation: 150,
          onEnd: () => {
            const order = Array.from(sectionList.querySelectorAll('.section-card')).map(
              (card) => card.dataset.sectionKey
            );
            fetch("{% url 'reorder_sections' %}", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
              },
              body: JSON.stringify({
                course_id: '{{ selected_course.id|default:"" }}',
                order: order,
              }),
            });
            reorderPreview(order);
          },
        });
      }

      document.querySelectorAll('.section-toggle').forEach((toggle) => {
        toggle.addEventListener('change', (event) => {
          const key = event.target.dataset.sectionKey;
          const isEnabled = event.target.checked;
          fetch("{% url 'toggle_section' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
              course_id: '{{ selected_course.id|default:"" }}',
              key: key,
              is_enabled: isEnabled,
            }),
          });
          updatePreviewToggle(key, isEnabled);
        });
      });

      document.querySelectorAll('[data-action-select]').forEach((select) => {
        updateActionVisibility(select);
        select.addEventListener('change', () => updateActionVisibility(select));
      });

      document.querySelectorAll('[data-hero-media-select]').forEach((select) => {
        updateHeroMediaVisibility(select);
        select.addEventListener('change', () => updateHeroMediaVisibility(select));
      });

      document.querySelectorAll('[data-list-add]').forEach((button) => {
        button.addEventListener('click', () => {
          const target = document.querySelector(button.dataset.listAdd);
          if (!target) return;
          const template = document.querySelector(button.dataset.template);
          if (template) {
            target.insertAdjacentHTML('beforeend', template.innerHTML);
          }
        });
      });

      document.addEventListener('click', async (event) => {
        if (event.target.matches('[data-list-remove]')) {
          const row = event.target.closest('[data-list-item]');
          if (row) row.remove();
          return;
        }

        const iconOption = event.target.closest('[data-hero-icon-option]');
        if (iconOption) {
          const iconClass = iconOption.dataset.heroIconOption || '';
          const iconLabel = iconOption.dataset.heroIconLabel || '';
          setHeroButtonIconSelection(iconClass, iconLabel);
          return;
        }

        const clearIconButton = event.target.closest('[data-hero-icon-clear]');
        if (clearIconButton) {
          event.preventDefault();
          setHeroButtonIconSelection('', '');
          return;
        }

        const heroLogoEditButton = event.target.closest('[data-hero-logo-edit]');
        if (heroLogoEditButton) {
          event.preventDefault();
          startHeroLogoEdit(heroLogoEditButton);
          return;
        }

        const heroButtonEditButton = event.target.closest('[data-hero-button-edit]');
        if (heroButtonEditButton) {
          event.preventDefault();
          startHeroButtonEdit(heroButtonEditButton);
          return;
        }

        const heroLogoCancel = event.target.closest('[data-hero-logo-cancel]');
        if (heroLogoCancel) {
          event.preventDefault();
          resetHeroLogoFormToAddMode();
          return;
        }

        const heroButtonCancel = event.target.closest('[data-hero-button-cancel]');
        if (heroButtonCancel) {
          event.preventDefault();
          resetHeroButtonFormToAddMode();
          return;
        }

        const overviewItemEditButton = event.target.closest('[data-overview-item-edit]');
        if (overviewItemEditButton) {
          event.preventDefault();
          startOverviewItemEdit(overviewItemEditButton);
          return;
        }

        const overviewItemCancel = event.target.closest('[data-overview-item-cancel]');
        if (overviewItemCancel) {
          event.preventDefault();
          resetOverviewItemFormToAddMode();
          return;
        }

        const editLink = event.target.closest('a[href*="edit_key="][href*="edit_id="]');
        if (!editLink) return;
        if (editLink.getAttribute('target') === '_blank') return;

        let linkUrl = null;
        try {
          linkUrl = new URL(editLink.getAttribute('href'), window.location.origin);
        } catch (error) {
          return;
        }

        if (linkUrl.pathname !== dashboardPath) return;

        const editKey = linkUrl.searchParams.get('edit_key');
        const editId = linkUrl.searchParams.get('edit_id');
        const courseRef = linkUrl.searchParams.get('course') || selectedCourseId;
        const section = linkUrl.searchParams.get('section') || '';
        if (!editKey || !editId || !courseRef) return;

        event.preventDefault();

        const payload = new FormData();
        payload.append('action', 'set_edit_context');
        payload.append('course', courseRef);
        payload.append('section', section);
        payload.append('edit_key', editKey);
        payload.append('edit_id', editId);

        try {
          const response = await fetch(dashboardUrl.toString(), {
            method: 'POST',
            body: payload,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken,
            },
          });

          let json = null;
          const contentType = response.headers.get('content-type') || '';
          if (contentType.includes('application/json')) {
            json = await response.json();
          }

          if (json && Array.isArray(json.messages)) {
            json.messages.forEach((entry) => {
              showToast(entry.text, entry.level);
            });
          }

          if (json && json.redirect_url) {
            window.location.assign(json.redirect_url);
          } else {
            window.location.reload();
          }
        } catch (error) {
          showToast('Unable to open editor. Please try again.', 'error');
        }
      });

      document.querySelectorAll('.toast').forEach((toastEl) => {
        const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
        toast.show();
      });

      document.querySelectorAll('form').forEach((form) => {
        form.querySelectorAll('input[required], textarea[required], select[required]').forEach((field) => {
          const fieldWrap = field.closest('.mb-3') || field.closest('.col-12') || field.closest('[class*="col-"]');
          const label = fieldWrap ? fieldWrap.querySelector('.form-label') : null;
          if (label && !label.classList.contains('required-label')) {
            label.classList.add('required-label');
          }
        });
      });

      document.querySelectorAll('[data-quill]').forEach((container) => {
        const targetId = container.dataset.target;
        const hiddenInput = document.getElementById(targetId);
        if (!hiddenInput) return;
        const quill = new Quill(container, {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline'],
              [{ list: 'ordered' }, { list: 'bullet' }],
              ['link'],
            ],
          },
        });
        if (hiddenInput.value) {
          quill.root.innerHTML = hiddenInput.value;
        }
        const form = container.closest('form');
        if (form) {
          quillEditors.push({ form, hiddenInput, quill });
          form.addEventListener('submit', () => {
            hiddenInput.value = quill.root.innerHTML;
          });
        }
      });

      resetHeroLogoFormToAddMode();
      resetHeroButtonFormToAddMode();
      resetOverviewItemFormToAddMode();
      ensureOverviewItemsEmptyState();
      initializeHeroAssetSorting();
      bindDashboardForms();
    </script>
  </body>
</html>
