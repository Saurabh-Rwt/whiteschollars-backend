<div class="container" id="key-highlight-panel">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Key Highlight</h5>
    </div>
    <div class="card-body">
      {% include 'components/course_dropdown.html' with dropdown_id='key-highlight-course' %}

      {% if selected_course %}
      <div class="editor-grid">
        <div class="editor-card">
          <div class="editor-step">
            <div class="editor-step-number">2</div>
            <div>
              <div class="editor-step-title">Add the key highlight</div>
              <p class="editor-helper">This appears near the top of the course page to summarize the main highlight.</p>
            </div>
          </div>

          <form method="POST" enctype="multipart/form-data" action="{% url 'add_key_highlight' %}" id="key-highlight-form">
            {% csrf_token %}
            <input type="hidden" name="course" value="{{ selected_course.id }}" />

            <div class="mb-3">
              <label for="key-highlight-logo" class="form-label">Highlight Icon</label>
              <input
                type="file"
                class="form-control"
                id="key-highlight-logo"
                name="logo"
                accept="image/*"
              />
              <div id="key-highlight-logo-preview" class="preview-stack mt-2">
                {% if existing_key_highlight and existing_key_highlight.logo %}
                  <img src="{{ existing_key_highlight.logo.url }}" alt="Current logo" class="preview-image" />
                {% endif %}
              </div>
            </div>

            <div class="mb-3">
              <label for="key-highlight-text" class="form-label">Highlight Text</label>
              <textarea
                class="form-control"
                id="key-highlight-text"
                name="text"
                rows="3"
                placeholder="Enter the key highlight text"
                required
              >{% if existing_key_highlight %}{{ existing_key_highlight.text }}{% endif %}</textarea>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-success px-4">Save Highlight</button>
            </div>
          </form>
        </div>

        <div class="preview-card" id="key-highlight-preview">
          <div class="preview-title">Live Preview</div>
          <div class="preview-stack mb-3">
            <img id="key-highlight-preview-logo" class="preview-image" alt="Highlight icon" {% if existing_key_highlight and existing_key_highlight.logo %}src="{{ existing_key_highlight.logo.url }}"{% endif %} />
            <span id="key-highlight-preview-logo-empty" class="preview-empty">Icon preview will appear here.</span>
          </div>
          <div id="key-highlight-preview-text" class="preview-muted">{% if existing_key_highlight %}{{ existing_key_highlight.text }}{% else %}Highlight text will appear here.{% endif %}</div>
        </div>
      </div>
      {% else %}
        <div class="editor-card">Select a course to add a key highlight.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function () {
    const container = document.getElementById("key-highlight-panel");
    if (!container) return;

    const form = container.querySelector("#key-highlight-form");
    if (!form) return;

    const textInput = form.querySelector("#key-highlight-text");
    const logoInput = form.querySelector("#key-highlight-logo");

    const previewText = container.querySelector("#key-highlight-preview-text");
    const previewLogo = container.querySelector("#key-highlight-preview-logo");
    const previewLogoEmpty = container.querySelector("#key-highlight-preview-logo-empty");
    const logoPreview = container.querySelector("#key-highlight-logo-preview");

    const updateTextPreview = () => {
      const value = textInput.value.trim();
      previewText.textContent = value || "Highlight text will appear here.";
    };

    const updateLogoPreview = (file) => {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        previewLogo.src = event.target.result;
        previewLogo.classList.remove("d-none");
        if (previewLogoEmpty) {
          previewLogoEmpty.style.display = "none";
        }
        if (logoPreview) {
          logoPreview.innerHTML = `<img src='${event.target.result}' class='preview-image' alt='Highlight icon' />`;
        }
      };
      reader.readAsDataURL(file);
    };

    textInput.addEventListener("input", updateTextPreview);
    logoInput.addEventListener("change", (event) => {
      updateLogoPreview(event.target.files[0]);
    });

    updateTextPreview();

    const hasLogo = previewLogo && previewLogo.getAttribute("src");
    if (hasLogo) {
      if (previewLogoEmpty) {
        previewLogoEmpty.style.display = "none";
      }
    } else if (previewLogoEmpty) {
      previewLogoEmpty.style.display = "block";
      previewLogo.classList.add("d-none");
    }
  })();
</script>
