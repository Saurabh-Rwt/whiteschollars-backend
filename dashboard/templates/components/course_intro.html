<div class="container" id="course-intro-panel">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white d-flex align-items-start justify-content-between">
      <div>
        <h5 class="mb-1">Course Intro</h5>
        <small class="text-white-50">Add the introductory block shown at the top of the course page.</small>
      </div>
      {% if editing_section %}
        <span class="badge bg-warning text-dark">Editing existing section</span>
      {% endif %}
    </div>
    <div class="card-body">
      {% include 'components/course_dropdown.html' with dropdown_id='course-intro-course' %}

      {% if selected_course %}
      <div class="editor-grid">
        <div class="editor-card">
          <div class="editor-step">
            <div class="editor-step-number">2</div>
            <div>
              <div class="editor-step-title">Fill the intro details</div>
              <p class="editor-helper">Use a clear heading, short description, and 2-5 bullet points.</p>
            </div>
          </div>

          {% if editing_section %}
            <div class="alert alert-warning py-2">
              You are editing a saved section. Updates will overwrite the existing entry.
              <a class="ms-2" href="{% url 'dashboard' %}?tab=course-intro&course={{ selected_course.id }}">Cancel editing</a>
            </div>
          {% endif %}

          <form method="POST" enctype="multipart/form-data" action="{% url 'add_section' %}" id="course-intro-form">
            {% csrf_token %}
            <input type="hidden" name="course" value="{{ selected_course.id }}" />
            {% if editing_section %}
              <input type="hidden" name="section_id" value="{{ editing_section.id }}" />
            {% endif %}

            <div class="mb-3">
              <label for="course-intro-logo" class="form-label">Logo</label>
              <input
                type="file"
                class="form-control"
                id="course-intro-logo"
                name="logo"
                accept="image/*"
              />
              <div id="course-intro-logo-preview" class="preview-stack mt-2">
                {% if editing_section and editing_section.logo %}
                  <img src="{{ editing_section.logo.url }}" alt="Current logo" class="preview-image" />
                {% endif %}
              </div>
              <div class="preview-muted mt-1">Recommended size: square image around 300x300.</div>
            </div>

            <div class="mb-3">
              <label for="course-intro-heading" class="form-label">Section Heading</label>
              <input
                type="text"
                class="form-control"
                id="course-intro-heading"
                name="section_heading"
                placeholder="Enter section heading"
                value="{% if editing_section %}{{ editing_section.section_heading }}{% endif %}"
                required
              />
            </div>

            <div class="mb-3">
              <label for="course-intro-text" class="form-label">Short Description</label>
              <textarea
                class="form-control"
                id="course-intro-text"
                name="text"
                rows="3"
                placeholder="Enter the intro description"
              >{% if editing_section %}{{ editing_section.text }}{% endif %}</textarea>
              <div class="preview-muted mt-1">Keep it short and easy to scan (2-4 lines).</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Key Points</label>
              <div id="course-intro-list-container">
                {% if editing_section and editing_section.list_text %}
                  {% for item in editing_section.list_text %}
                    <div class="input-group mb-2">
                      <input
                        type="text"
                        class="form-control"
                        name="list_text[]"
                        value="{{ item }}"
                        placeholder="Enter a bullet point"
                      />
                      <button type="button" class="btn btn-outline-danger course-intro-remove-list">Remove</button>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="input-group mb-2">
                    <input
                      type="text"
                      class="form-control"
                      name="list_text[]"
                      placeholder="Enter a bullet point"
                    />
                    <button type="button" class="btn btn-outline-danger course-intro-remove-list" disabled>Remove</button>
                  </div>
                {% endif %}
              </div>
              <button type="button" class="btn btn-outline-success btn-sm" id="course-intro-add-list">Add another point</button>
            </div>

            <div class="mb-3">
              <label for="course-intro-collab" class="form-label">Collaboration Logos</label>
              <input
                type="file"
                class="form-control"
                id="course-intro-collab"
                name="collaboration_logo[]"
                accept="image/*"
                multiple
              />
              <div id="course-intro-collab-preview" class="preview-stack mt-2"></div>
              {% if editing_section and editing_section.collaboration_logo %}
                <div class="preview-stack mt-2">
                  {% for logo in editing_section.collaboration_logo %}
                    <img src="/media/{{ logo }}" alt="Existing logo" class="preview-image" />
                  {% endfor %}
                </div>
                <div class="preview-muted mt-1">Uploading new logos will add to the existing ones.</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label for="course-intro-video" class="form-label">Course YouTube Video Link</label>
              <input
                type="url"
                class="form-control"
                id="course-intro-video"
                name="youtube_video"
                placeholder="https://www.youtube.com/watch?v=example"
                value="{% if editing_section %}{{ editing_section.youtube_video }}{% endif %}"
              />
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-success px-4">
                {% if editing_section %}Update Intro{% else %}Save Intro{% endif %}
              </button>
            </div>
          </form>
        </div>

        <div class="preview-card" id="course-intro-preview">
          <div class="preview-title">Live Preview</div>
          <div class="preview-muted mb-3">Course: {{ selected_course.name }}</div>
          <div class="preview-stack mb-3">
            <img id="course-intro-preview-logo" class="preview-image" alt="Logo preview" {% if editing_section and editing_section.logo %}src="{{ editing_section.logo.url }}"{% endif %} />
            <span id="course-intro-preview-logo-empty" class="preview-empty">Logo preview will appear here.</span>
          </div>
          <h6 id="course-intro-preview-heading">{% if editing_section %}{{ editing_section.section_heading }}{% else %}Section heading will appear here{% endif %}</h6>
          <p id="course-intro-preview-text" class="preview-muted">{% if editing_section %}{{ editing_section.text }}{% else %}Short description preview will appear here.{% endif %}</p>
          <ul id="course-intro-preview-list" class="preview-list"></ul>
          <div id="course-intro-preview-video" class="preview-muted mt-3"></div>
          <div id="course-intro-preview-collab" class="preview-stack mt-3"></div>
        </div>
      </div>

      <div class="editor-card mt-4">
        <h6 class="mb-3">Existing Intro Sections</h6>
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead>
              <tr>
                <th>Logo</th>
                <th>Heading</th>
                <th>Text</th>
                <th>Key Points</th>
                <th>YouTube Video</th>
                <th>Collab Logos</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for sec in sections %}
              <tr>
                <td>
                  {% if sec.logo %}
                    <img src="{{ sec.logo.url }}" width="60" height="60" class="img-thumbnail" alt="Logo" />
                  {% else %}-{% endif %}
                </td>
                <td>{{ sec.section_heading }}</td>
                <td>{{ sec.text|default:"-" }}</td>
                <td>
                  {% for item in sec.list_text %}
                    - {{ item }}<br />
                  {% empty %}-{% endfor %}
                </td>
                <td>{{ sec.youtube_video|default:"-" }}</td>
                <td>
                  {% for logo in sec.collaboration_logo %}
                    <img src="/media/{{ logo }}" width="50" height="50" class="img-thumbnail me-1" alt="Logo" />
                  {% empty %}-{% endfor %}
                </td>
                <td class="text-nowrap">
                  <a href="{% url 'edit_section' sec.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                  <a
                    href="{% url 'delete_section' sec.id %}"
                    class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Delete this section?')"
                  >
                    Delete
                  </a>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center">No intro sections saved yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
        <div class="editor-card">Select a course to start editing the intro section.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function () {
    const container = document.getElementById("course-intro-panel");
    if (!container) return;

    const form = container.querySelector("#course-intro-form");
    if (!form) return;

    const headingInput = form.querySelector("#course-intro-heading");
    const textInput = form.querySelector("#course-intro-text");
    const videoInput = form.querySelector("#course-intro-video");
    const listContainer = form.querySelector("#course-intro-list-container");
    const addListBtn = form.querySelector("#course-intro-add-list");
    const logoInput = form.querySelector("#course-intro-logo");
    const collabInput = form.querySelector("#course-intro-collab");

    const previewHeading = container.querySelector("#course-intro-preview-heading");
    const previewText = container.querySelector("#course-intro-preview-text");
    const previewVideo = container.querySelector("#course-intro-preview-video");
    const previewList = container.querySelector("#course-intro-preview-list");
    const previewLogo = container.querySelector("#course-intro-preview-logo");
    const previewLogoEmpty = container.querySelector("#course-intro-preview-logo-empty");
    const previewCollab = container.querySelector("#course-intro-preview-collab");
    const logoPreview = container.querySelector("#course-intro-logo-preview");
    const collabPreview = container.querySelector("#course-intro-collab-preview");

    const updateTextPreview = () => {
      const headingValue = headingInput.value.trim();
      previewHeading.textContent = headingValue || "Section heading will appear here";

      const textValue = textInput.value.trim();
      previewText.textContent = textValue || "Short description preview will appear here.";
    };

    const updateVideoPreview = () => {
      const videoValue = videoInput.value.trim();
      previewVideo.textContent = videoValue
        ? `YouTube link: ${videoValue}`
        : "YouTube link will appear here.";
    };

    const updateListPreview = () => {
      const items = Array.from(listContainer.querySelectorAll("input[name='list_text[]']"))
        .map((input) => input.value.trim())
        .filter(Boolean);

      previewList.innerHTML = "";
      if (!items.length) {
        previewList.innerHTML = "<li class='preview-empty'>Bullet points will appear here.</li>";
        return;
      }

      items.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item;
        previewList.appendChild(li);
      });
    };

    const updateLogoPreview = (file) => {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        previewLogo.src = event.target.result;
        previewLogo.classList.remove("d-none");
        if (previewLogoEmpty) {
          previewLogoEmpty.style.display = "none";
        }
        if (logoPreview) {
          logoPreview.innerHTML = `<img src='${event.target.result}' class='preview-image' alt='Logo preview' />`;
        }
      };
      reader.readAsDataURL(file);
    };

    const updateCollabPreview = (files) => {
      previewCollab.innerHTML = "";
      if (collabPreview) collabPreview.innerHTML = "";
      if (!files || !files.length) {
        previewCollab.innerHTML = "<span class='preview-empty'>Collaboration logos will appear here.</span>";
        return;
      }

      Array.from(files).forEach((file) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement("img");
          img.src = event.target.result;
          img.alt = "Collaboration logo";
          img.className = "preview-image";
          previewCollab.appendChild(img.cloneNode(true));
          if (collabPreview) {
            collabPreview.appendChild(img);
          }
        };
        reader.readAsDataURL(file);
      });
    };

    addListBtn.addEventListener("click", () => {
      const row = document.createElement("div");
      row.className = "input-group mb-2";
      row.innerHTML = "<input type='text' class='form-control' name='list_text[]' placeholder='Enter a bullet point' /><button type='button' class='btn btn-outline-danger course-intro-remove-list'>Remove</button>";
      listContainer.appendChild(row);
      updateListPreview();
    });

    listContainer.addEventListener("click", (event) => {
      const target = event.target;
      if (target.classList.contains("course-intro-remove-list")) {
        const row = target.closest(".input-group");
        if (row && listContainer.children.length > 1) {
          row.remove();
          updateListPreview();
        }
      }
    });

    listContainer.addEventListener("input", (event) => {
      if (event.target.matches("input[name='list_text[]']")) {
        updateListPreview();
      }
    });

    headingInput.addEventListener("input", updateTextPreview);
    textInput.addEventListener("input", updateTextPreview);
    videoInput.addEventListener("input", updateVideoPreview);

    logoInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      updateLogoPreview(file);
    });

    collabInput.addEventListener("change", (event) => {
      updateCollabPreview(event.target.files);
    });

    updateTextPreview();
    updateVideoPreview();
    updateListPreview();
    updateCollabPreview(collabInput.files);

    const hasLogo = previewLogo && previewLogo.getAttribute("src");
    if (hasLogo) {
      if (previewLogoEmpty) {
        previewLogoEmpty.style.display = "none";
      }
    } else if (previewLogoEmpty) {
      previewLogoEmpty.style.display = "block";
      previewLogo.classList.add("d-none");
    }
  })();
</script>
