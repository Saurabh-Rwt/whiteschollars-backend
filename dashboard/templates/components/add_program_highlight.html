<div class="container" id="program-highlight-panel">
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Program Highlights</h5>
    </div>

    <div class="card-body">
      {% include 'components/course_dropdown.html' with dropdown_id='program-highlight-course' %}

      {% if selected_course %}
      <div class="editor-grid">
        <div class="editor-card">
          <div class="editor-step">
            <div class="editor-step-number">2</div>
            <div>
              <div class="editor-step-title">Add a program highlight</div>
              <p class="editor-helper">Use a title, heading, and 3-6 bullet points.</p>
            </div>
          </div>

          <form method="POST" enctype="multipart/form-data" action="{% url 'add_program_highlight' %}" id="program-highlight-form">
            {% csrf_token %}
            <input type="hidden" name="course" value="{{ selected_course.id }}" />

            <div class="mb-3">
              <label for="program-highlight-title" class="form-label">Title</label>
              <input type="text" class="form-control" id="program-highlight-title" name="title" placeholder="Enter title" required />
            </div>

            <div class="mb-3">
              <label for="program-highlight-heading" class="form-label">Heading</label>
              <input type="text" class="form-control" id="program-highlight-heading" name="heading" placeholder="Enter heading" required />
            </div>

            <div class="mb-3">
              <label class="form-label">Program Details</label>
              <div class="input-group mb-2">
                <input type="text" id="program-highlight-detail" class="form-control" placeholder="Enter detail" />
                <button type="button" id="program-highlight-add-detail" class="btn btn-outline-success">Add</button>
              </div>
              <ul id="program-highlight-detail-list" class="list-group"></ul>
              <input type="hidden" name="text" id="program-highlight-text" />
              <div class="preview-muted mt-1">Add one detail at a time and click Add.</div>
            </div>

            <div class="mb-3">
              <label for="program-highlight-image" class="form-label">Image</label>
              <input type="file" class="form-control" id="program-highlight-image" name="image" accept="image/*" />
              <div id="program-highlight-image-preview" class="preview-stack mt-2"></div>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-success px-4">Save Highlight</button>
            </div>
          </form>
        </div>

        <div class="preview-card" id="program-highlight-preview">
          <div class="preview-title">Live Preview</div>
          <div class="preview-stack mb-3">
            <img id="program-highlight-preview-image" class="preview-image" alt="Highlight image" />
            <span id="program-highlight-preview-image-empty" class="preview-empty">Image preview will appear here.</span>
          </div>
          <h6 id="program-highlight-preview-title">Title</h6>
          <div id="program-highlight-preview-heading" class="preview-muted">Heading</div>
          <ul id="program-highlight-preview-list" class="preview-list mt-3"></ul>
        </div>
      </div>

      {% if program_highlights %}
        <div class="editor-card mt-4">
          <h6 class="mb-3">Saved Program Highlights</h6>
          <div class="row g-3">
            {% for highlight in program_highlights %}
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body">
                    <strong>{{ highlight.title }}</strong>
                    <div class="preview-muted">{{ highlight.heading }}</div>
                    {% if highlight.text %}
                      <ul class="mt-2 mb-0">
                        {% for item in highlight.text %}
                          <li>{{ item }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
      {% else %}
        <div class="editor-card">Select a course to add program highlights.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function () {
    const container = document.getElementById("program-highlight-panel");
    if (!container) return;

    const form = container.querySelector("#program-highlight-form");
    if (!form) return;

    const titleInput = form.querySelector("#program-highlight-title");
    const headingInput = form.querySelector("#program-highlight-heading");
    const detailInput = form.querySelector("#program-highlight-detail");
    const addDetailBtn = form.querySelector("#program-highlight-add-detail");
    const detailList = form.querySelector("#program-highlight-detail-list");
    const hiddenText = form.querySelector("#program-highlight-text");
    const imageInput = form.querySelector("#program-highlight-image");
    const imagePreview = container.querySelector("#program-highlight-image-preview");

    const previewTitle = container.querySelector("#program-highlight-preview-title");
    const previewHeading = container.querySelector("#program-highlight-preview-heading");
    const previewList = container.querySelector("#program-highlight-preview-list");
    const previewImage = container.querySelector("#program-highlight-preview-image");
    const previewImageEmpty = container.querySelector("#program-highlight-preview-image-empty");

    const details = [];

    const syncDetails = () => {
      hiddenText.value = JSON.stringify(details);
      previewList.innerHTML = "";

      if (!details.length) {
        previewList.innerHTML = "<li class='preview-empty'>Program details will appear here.</li>";
        return;
      }

      details.forEach((item) => {
        const li = document.createElement("li");
        li.textContent = item;
        previewList.appendChild(li);
      });
    };

    addDetailBtn.addEventListener("click", () => {
      const detail = detailInput.value.trim();
      if (!detail) return;
      details.push(detail);
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between align-items-center";
      li.innerHTML = `${detail}<button type='button' class='btn btn-sm btn-outline-danger program-highlight-remove'>Remove</button>`;
      detailList.appendChild(li);
      detailInput.value = "";
      syncDetails();
    });

    detailList.addEventListener("click", (event) => {
      if (!event.target.classList.contains("program-highlight-remove")) return;
      const itemText = event.target.closest("li").firstChild.textContent.trim();
      const index = details.indexOf(itemText);
      if (index > -1) {
        details.splice(index, 1);
      }
      event.target.closest("li").remove();
      syncDetails();
    });

    const updateTextPreview = () => {
      previewTitle.textContent = titleInput.value.trim() || "Title";
      previewHeading.textContent = headingInput.value.trim() || "Heading";
    };

    titleInput.addEventListener("input", updateTextPreview);
    headingInput.addEventListener("input", updateTextPreview);

    imageInput.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewImage.classList.remove("d-none");
        if (previewImageEmpty) {
          previewImageEmpty.style.display = "none";
        }
        imagePreview.innerHTML = `<img src='${e.target.result}' class='preview-image' alt='Highlight image' />`;
      };
      reader.readAsDataURL(file);
    });

    updateTextPreview();
    syncDetails();
  })();
</script>
